{% extends 'main_template.html' %}
{% load static %}

{% block head %}
<title>Профиль {username}</title>
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<style>
  .scrum-board {
    display: flex;
    overflow-x: auto;
  }

  .scrum-column {
    flex: 1;
    margin: 0 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 15px;
  }

  .scrum-card {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block body %}

<body>
  <section style="background-color: #eee;">
    <div class="container py-5">
      <div class="row">
        <div class="col-lg-4">
          <!-- Блок с профилем команды -->
          <div class="card mb-4">
            <div class="card-body text-center">
              <img src="{{ team_photo_url }}" alt="{{ team.title }} photo" class="img-fluid"
                style="width: 150px; height: 165px;">
              <h5 class="my-3">{{ team.title }}</h5>
              {% if user == team.owner %}
              <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#EditTeamProfile">
                Редактировать </button>
              {% endif %}
              <div class="mb-2">
                <p class="mt-4 mb-1" style="font-size: .77rem;">{{ team.xp }}</p>
                <div class="progress rounded mb-2" style="height: 5px;">
                  <div class="progress-bar" role="progressbar" style="width: 66%" aria-valuenow="66" aria-valuemin="0"
                    aria-valuemax="100"></div>
                </div>
              </div>
            </div>
            <div class="card  mb-4">
              <div class="card-body text-center">
                <div class="row">
                  <div class="col-sm-4">
                    <p class="mb-0">Дата создания</p>
                  </div>
                  <div class="col-sm-7">
                    <p class="text-muted mb-0">{{ team.created_at }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Блок с участниками -->
        <div class="col-lg-8">
          <div class="row">
            <div class="col">
              <div class="card mb-4 mb-md-0">
                <div class="row">
                  <div class="col-2"></div>
                  <div class="col-4">
                    <h3 class=" ms-4 mt-2">Участники</h3>
                  </div>
                  {% if user == team.owner %}
                  <div class="col-4">
                    <button class="btn btn-outline-dark mt-2" data-bs-toggle="modal"
                      data-bs-target="#InviteUser">Пригласить</button>
                  </div>
                  {% endif %}
                </div>
                <div class="card-body" style="overflow-y: auto; height:382px;">
                  <!-- Карточка участника -->
                  {% for member, photo_url in members %}
                  <div class="card ms-1 me-1 mb-1">
                    <div class="row align-items-center">
                      <div class="col-2 m-1">
                        <img src="{{ photo_url }}" class="card-img-top rounded-circle mx-auto d-block m-1"
                          style="width: 50px; height: 50px;">
                      </div>
                      <div class="col-6" style="font-size: 14.5pt;">
                        <p>{{ member.employee.last_name }} {{ member.employee.first_name }}
                          {{ member.employee.patronymic }}</p>
                      </div>
                      <div class="col-2" style="font-size: 14pt;">
                        {% if member.employee == team.owner %}
                        Создатель
                        {% else %}
                        Участник
                        {% endif %}
                      </div>
                      {% if user == team.owner and member.employee != team.owner %}
                      <div class="col-1">
                        <button class="btn btn-sm btn-outline-dark">Х</button>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Scrum-доска -->
        <div class="container">
          <div class="card">
            <div class="row d-flex justify-content-center align-items-center">
              <div class="col-2"></div>
              <div class="col-4 text-center m-2">
                <h1>Задачи команды</h1>
              </div>
              {% if user == team.owner %}
              <div class="col-2 text-end">
                <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#CreateTaskModal">Создать
                  задачу</button>
              </div>
              {% endif %}
            </div>
            <div class="scrum-board">
              <div class="scrum-column">
                <h2 class="text-center">В ожидании</h2>
                {% for task in waiting_tasks %}
                <div class="scrum-card">
                  <div class="row">
                    <div class="col-10">
                      <h5>{{ task.title }}</h5>
                    </div>
                    {% if user == team.owner %}
                    <div class="col-2">
                      <button class="btn btn-sm btn-outline-dark">X</button>
                    </div>
                    {% endif %}
                    <div class="row"></div>
                    <p>{{ task.description }}</p>
                  </div>
                </div>
                {% endfor %}
              </div>

              <div class="scrum-column">
                <h2 class="text-center">В процессе</h2>
                {% for task in in_progress_tasks %}
                <div class="scrum-card">
                  <div class="row">
                    <div class="col-10">
                      <h5>{{ task.title }}</h5>
                    </div>
                    {% if user == team.owner %}
                    <div class="col-2">
                      <button class="btn btn-sm btn-outline-dark">X</button>
                    </div>
                    {% endif %}
                    <div class="row"></div>
                    <p>{{ task.description }}</p>
                  </div>
                </div>
                {% endfor %}
              </div>

              <div class="scrum-column">
                <h2 class="text-center">Выполнено</h2>
                {% for task in completed_tasks %}
                <div class="scrum-card">
                  <div class="row">
                    <div class="col-10">
                      <h5>{{ task.title }}</h5>
                    </div>
                    {% if user == team.owner %}
                    <div class="col-2">
                      <button class="btn btn-sm btn-outline-dark">X</button>
                    </div>
                    {% endif %}
                    <div class="row"></div>
                    <p>{{ task.description }}</p>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </section>

  <!-- Modal-window CreateTasks -->
  <div class="modal fade" id="CreateTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Создание задачи</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createTaskForm" method="post" action="{% url 'create_task' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Название:</label>
              <input type="text" class="form-control" id="recipient-name" name="title">
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Описание</label>
              <textarea class="form-control" id="message-text" name="description"></textarea>
            </div>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="task-executor-tb" placeholder="Выберите исполнителя">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false">Участники</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <!-- Можно как-то придумать хранение id-шников в data-value -->
                <!-- Загружать сюда данные только участников команды -->
                {% for member, photo in members %}
                <li><a class="dropdown-item" href="#" data-value="{{ member.employee.id }}">
                    {{ member.employee.last_name}} {{ member.employee.first_name }} {{ member.employee.patronymic }}</a>
                </li>
                {% endfor %}
              </ul>
            </div>
            <input type="hidden" id="executor_id" name="executor">
            <input type="hidden" name="team_id" value="{{ team.team_id }}">
            <div class="container d-flex justify-content-end"></div>
            <button type="button" class="btn btn-secondary m-1" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary m-1">Создать</button>
        </div>
        </form>
      </div>
    </div>
  </div>
  </div>


  <!-- Modal-window EditTeamProfile -->
  <div class="modal fade" id="EditTeamProfile" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Редактирование команды</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editTeamForm" method="post" action="{% url 'edit_team' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Название:</label>
              <input type="text" class="form-control" id="team-name-tb" name="title" value="{{ team.title }}">
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Фото:</label>
              <input class="form-control" type="file" id="photo-team-profile-tb" name="photo" accept="image/*">
            </div>
            <input type="hidden" name="team_id" value="{{ team.team_id }}">
            <div class="container d-flex justify-content-end">
              <button type="button" class="btn btn-secondary m-1" data-bs-dismiss="modal">Отмена</button>
              <button type="submit" class="btn btn-primary m-1">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal-window InviteUser -->
  <div class="modal fade" id="InviteUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Приглашение в команду</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="invite-user-tb" placeholder="Кого вы хотите пригласить?">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false">Пользователи</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-value="1">Шляпкин Антон Александрович</a></li>
                <li><a class="dropdown-item" href="#" data-value="2">Наталья Морская Пехота</a></li>
                <li><a class="dropdown-item" href="#" data-value="3">Жмышенко Валерий </a></li>
              </ul>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal-window TaskDetail -->
  <div class="modal fade" id="TaskDetail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Подробнее о задаче</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Название</label>
            <input type="text" class="form-control" id="task-detail-name-tb">
          </div>
          <div class="mb-3">
            <label class="form-label">Описание</label>
            <textarea class="form-control" id="task-detail-description-tb" rows="3"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script>
    // document.querySelectorAll('#CreateTaskModal .dropdown-item').forEach(item => {
    //   item.addEventListener('click', event => {
    //     event.preventDefault();
    //     document.getElementById('task-executor-tb').value = event.target.innerText;
    //   });
    // });

    // create task script
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('createTaskForm');
      const editForm = document.getElementById('editTeamForm'); // Исправлено на editTeamForm
      const dropdownItems = document.querySelectorAll('.dropdown-item');
      const executorInput = document.getElementById('task-executor-tb');
      const executorIdInput = document.getElementById('executor_id');

      dropdownItems.forEach(item => {
        item.addEventListener('click', function (event) {
          event.preventDefault();
          executorInput.value = item.innerText;
          executorIdInput.value = item.getAttribute('data-value');
        });
      });

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              clearFormFields();
              window.location.reload();
            } else {
              alert('Ошибка при создании задачи');
            }
          })
          .catch(error => {
            console.error('Ошибка при отправке запроса:', error);
          });
      });

      editForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(editForm);
        const teamId = editForm.querySelector('input[name="team_id"]').value; // Получаем team_id из формы
        fetch(editForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.reload();
            } else {
              alert('Ошибка при редактировании команды');
            }
          })
          .catch(error => {
            console.error('Ошибка при отправке запроса:', error);
          });
      });

      function clearFormFields() {
        document.getElementById('recipient-name').value = '';
        document.getElementById('message-text').value = '';
        document.getElementById('task-executor-tb').value = '';
        document.getElementById('executor_id').value = '';
      }
    });


    document.querySelectorAll('#InviteUser .dropdown-item').forEach(item => {
      item.addEventListener('click', event => {
        event.preventDefault();
        document.getElementById('invite-user-tb').value = event.target.innerText;
      });
    });

    // edit team profile script



    //TODO: Здесь и крестик тоже вызывает модальное окно
    document.querySelectorAll('.scrum-card').forEach(item => {
      const title = item.querySelector('h5').innerText;
      const description = item.querySelector('p').innerText;
      item.dataset.bsToggle = "modal";
      item.dataset.bsTarget = "#TaskDetail";
      item.addEventListener('click', () => fillTaskDetail(title, description));
    });
    function fillTaskDetail(title, description) {
      document.getElementById('task-detail-name-tb').value = title;
      document.getElementById('task-detail-description-tb').value = description;
    };

    document.getElementsByClassName()
  </script>


</body>

{% endblock %}

{% block js-scripts %}
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
{% endblock %}